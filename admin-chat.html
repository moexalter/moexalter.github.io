<!DOCTYPE html>
<html>
<head>
    <title>Mo's Admin Chat</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 10px; overflow: hidden; }
        .header { background: #667eea; color: white; padding: 20px; }
        .main { display: flex; min-height: 500px; }
        .sidebar { width: 250px; border-right: 1px solid #ddd; padding: 15px; }
        .chat-area { flex: 1; display: flex; flex-direction: column; }
        .messages { flex: 1; padding: 20px; overflow-y: auto; max-height: 400px; }
        .input-area { padding: 15px; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:disabled { opacity: 0.5; }
        .message { margin: 10px 0; padding: 10px; border-radius: 8px; max-width: 70%; }
        .visitor { background: #e3f2fd; margin-right: auto; }
        .admin { background: #667eea; color: white; margin-left: auto; }
    </style>
    
    <!-- SUPABASE LIBRARY MUST BE LOADED FIRST -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ‘‘ Admin Chat</h1>
        </div>
        <div class="main">
            <div class="sidebar">
                <h3>Active Chat</h3>
                <div id="conversations">Loading...</div>
            </div>
            <div class="chat-area">
                <div class="messages" id="messages">Loading messages...</div>
                <div class="input-area">
                    <input type="text" id="messageInput" placeholder="Type reply...">
                    <button id="sendBtn">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Wait for the page to load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Supabase
            const supabaseUrl = 'https://eecvxrcagzksvaboageo.supabase.co';
            const supabaseKey = 'sb_publishable_yVh969gWeMM--mYCEXpQkg_AUIEufDj';
            
            // Check if supabase library is loaded
            if (typeof supabase === 'undefined') {
                console.error('Supabase library not loaded!');
                document.getElementById('messages').innerHTML = 'Error: Supabase library failed to load.';
                return;
            }
            
            // Create client
            const client = supabase.createClient(supabaseUrl, supabaseKey);
            console.log('Supabase client created');
            
            // Initialize the app
            initializeApp(client);
        });
        
        function initializeApp(supabaseClient) {
            const messagesDiv = document.getElementById('messages');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const conversationsDiv = document.getElementById('conversations');
            
            // Load messages
            async function loadMessages() {
                try {
                    console.log('Loading messages...');
                    const { data, error } = await supabaseClient
                        .from('mo_chat_messages')
                        .select('*')
                        .order('timestamp', { ascending: true });
                    
                    if (error) {
                        console.error('Supabase error:', error);
                        messagesDiv.innerHTML = 'Error loading: ' + error.message;
                        return;
                    }
                    
                    console.log('Loaded', data.length, 'messages');
                    displayMessages(data);
                    updateConversations(data);
                    
                } catch (error) {
                    console.error('Error:', error);
                    messagesDiv.innerHTML = 'Error loading messages';
                }
            }
            
            function displayMessages(messages) {
                if (messages.length === 0) {
                    messagesDiv.innerHTML = 'No messages yet. Send one from the chat page.';
                    return;
                }
                
                messagesDiv.innerHTML = '';
                
                messages.forEach(msg => {
                    const div = document.createElement('div');
                    const isVisitor = msg.sender === 'You' || msg.sender === 'Visitor';
                    div.className = `message ${isVisitor ? 'visitor' : 'admin'}`;
                    div.innerHTML = `
                        <strong>${msg.sender}:</strong> ${msg.message || '(file shared)'}
                        <br><small>${new Date(msg.timestamp).toLocaleTimeString()}</small>
                    `;
                    messagesDiv.appendChild(div);
                });
                
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
            
            function updateConversations(messages) {
                const visitorCount = messages.filter(m => m.sender === 'You' || m.sender === 'Visitor').length;
                conversationsDiv.innerHTML = `
                    <div style="padding: 10px; background: #f0f0f0; border-radius: 5px;">
                        <strong>Website Visitor</strong><br>
                        <small>${messages.length} total messages</small><br>
                        <small>${visitorCount} from visitor</small>
                    </div>
                `;
            }
            
            // Send message
            async function sendMessage() {
                const text = messageInput.value.trim();
                if (!text) return;
                
                sendBtn.disabled = true;
                sendBtn.textContent = 'Sending...';
                
                try {
                    console.log('Sending message:', text);
                    const { data, error } = await supabaseClient
                        .from('mo_chat_messages')
                        .insert([
                            { 
                                sender: 'Admin',
                                message: text,
                                room: 'mo_chat',
                                timestamp: new Date().toISOString()
                            }
                        ]);
                    
                    if (error) {
                        console.error('Send error:', error);
                        alert('Failed to send: ' + error.message + '\n\nCheck RLS policies in Supabase.');
                        return;
                    }
                    
                    console.log('Message sent:', data);
                    messageInput.value = '';
                    loadMessages(); // Reload
                    
                } catch (error) {
                    console.error('Unexpected error:', error);
                    alert('Failed to send');
                } finally {
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Send';
                    messageInput.focus();
                }
            }
            
            // Real-time updates
            supabaseClient
                .channel('mo_chat')
                .on('INSERT', payload => {
                    console.log('New message received:', payload.new);
                    loadMessages();
                })
                .subscribe();
            
            // Event listeners
            sendBtn.onclick = sendMessage;
            messageInput.onkeypress = (e) => {
                if (e.key === 'Enter') sendMessage();
            };
            
            // Initial load
            loadMessages();
            
            // Auto-refresh
            setInterval(loadMessages, 10000);
        }
    </script>
</body>
</html>
