W<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Mo | Live Support</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
        }
        
        .chat-header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
            max-width: 800px;
        }
        
        .chat-header h1 {
            font-size: 48px;
            margin-bottom: 15px;
            font-weight: 700;
        }
        
        .chat-header p {
            font-size: 18px;
            opacity: 0.9;
            line-height: 1.6;
        }
        
        .chat-container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .chat-info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .info-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .info-card h3 {
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-card p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        /* Chat widget will be inserted here */
        #chat-widget-container {
            flex: 1;
        }
        
        .response-time {
            text-align: center;
            color: white;
            margin-top: 30px;
            font-size: 14px;
            opacity: 0.8;
        }
        
        @media (max-width: 768px) {
            .chat-header h1 {
                font-size: 36px;
            }
            
            .chat-header p {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-header">
        <h1>üí¨ Chat with Mo</h1>
        <p>Get instant responses, share files, and discuss projects in real-time. 
           I typically respond within a few hours during business days.</p>
    </div>
    
    <div class="chat-container">
        <div class="chat-info-cards">
            <div class="info-card">
                <h3>üïí Response Time</h3>
                <p>Usually within 2-4 hours during weekdays (9AM-6PM IST)</p>
            </div>
            <div class="info-card">
                <h3>üìÅ File Sharing</h3>
                <p>Share images, PDFs, documents up to 5MB each</p>
            </div>
            <div class="info-card">
                <h3>üíæ Chat History</h3>
                <p>All messages are saved for future reference</p>
            </div>
            <div class="info-card">
                <h3>üîí Secure & Private</h3>
                <p>End-to-end encrypted, stored in secure database</p>
            </div>
        </div>
        
        <!-- Chat Widget will be placed here -->
        <div id="chat-widget-container"></div>
    </div>
    
    <div class="response-time">
        <p>üìç Based in Chennai, India (IST: UTC+5:30) | üìß mohraf@gmail.com | üì± +91 98402 40611</p>
    </div>

    <!-- Chat Widget Script will be inserted here -->
</body>
</html>

<!-- ======= Chat Widget ======= -->
<div id="chat-widget" style="width: 100%; max-width: 1000px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 25px 70px rgba(0,0,0,0.15); overflow: hidden; height: 70vh;">
  
  <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px 30px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h2 style="margin: 0; font-size: 28px;">üí¨ Mo's Live Chat</h2>
        <p style="margin: 8px 0 0; font-size: 16px; opacity: 0.9;">Direct conversation with Mo - Send messages & files</p>
      </div>
      <div style="display: flex; align-items: center; gap: 15px;">
        <div style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; font-size: 14px;">
          <span id="connection-status">üü¢ Connected</span>
        </div>
        <button id="chat-close" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; display: none;">
          √ó
        </button>
      </div>
    </div>
  </div>
  
  <!-- Chat Messages Area -->
  <div id="chat-messages" style="flex: 1; padding: 30px; overflow-y: auto; background: #f8f9fa; height: calc(70vh - 180px);">
    <div style="text-align: center; margin: 30px 0;">
      <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); display: inline-block;">
        <div style="font-size: 18px; color: #333; margin-bottom: 10px;">Welcome to direct chat with Mo! üëã</div>
        <div style="font-size: 14px; color: #666; max-width: 500px;">
          This is a real conversation. Messages are stored and Mo will respond when available.
          You can share files, images, or ask questions about projects.
        </div>
      </div>
    </div>
  </div>
  
  <!-- File Preview -->
  <div id="file-preview" style="display: none; padding: 15px 30px; background: #f0f7ff; border-top: 1px solid #d0e0ff;">
    <div style="display: flex; align-items: center; justify-content: space-between;">
      <div style="display: flex; align-items: center; gap: 15px;">
        <div id="file-icon" style="font-size: 28px;">üìé</div>
        <div>
          <div id="file-name" style="font-weight: 600; font-size: 16px;"></div>
          <div id="file-size" style="font-size: 14px; color: #666;"></div>
        </div>
      </div>
      <button id="remove-file" style="background: none; border: none; color: #ff6b6b; cursor: pointer; font-size: 24px;">
        √ó
      </button>
    </div>
  </div>
  
  <!-- Chat Input Area -->
  <div style="border-top: 1px solid #e0e0e0; padding: 25px 30px; background: white;">
    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
      <!-- File Upload -->
      <label for="file-upload" style="cursor: pointer; background: #f8f9fa; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px dashed #c0c0c0; transition: all 0.3s;">
        <span style="font-size: 22px;">üìé</span>
        <input type="file" id="file-upload" accept="image/*,.pdf,.doc,.docx,.txt" style="display: none;">
      </label>
      
      <!-- Text Input -->
      <input type="text" id="chat-input" placeholder="Type your message to Mo..." style="flex: 1; padding: 18px 25px; border: 2px solid #e0e0e0; border-radius: 30px; font-size: 16px; transition: all 0.3s;">
      
      <!-- Send Button -->
      <button id="chat-send" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; width: 60px; height: 60px; border-radius: 50%; cursor: pointer; font-size: 22px; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); transition: all 0.3s;">
        ‚Üí
      </button>
    </div>
    
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div style="font-size: 13px; color: #999;">
        <span>Max file: 5MB</span>
        <span style="margin-left: 20px;">Formats: Images, PDF, DOC, TXT</span>
        <span style="margin-left: 20px;">Press Enter to send</span>
      </div>
      <div id="typing-indicator" style="font-size: 14px; color: #667eea; display: none;">
        <span style="display: inline-block; animation: pulse 1.5s infinite;">‚óè</span> Mo is typing...
      </div>
    </div>
  </div>
</div>

<script>
// Chat functionality will be added next
</script>

<style>
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

#chat-input:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

#chat-send:hover {
  transform: scale(1.05);
}

#chat-messages::-webkit-scrollbar {
  width: 10px;
}

#chat-messages::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 5px;
}

#chat-messages::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 5px;
}

#chat-messages::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}
</style>
<!-- ======= End Chat Widget ======= -->

<!-- Supabase Initialization -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // Initialize Supabase
  const supabaseUrl = 'https://eecvxrcagzksvaboageo.supabase.co';
  const supabaseKey = 'sb_publishable_yVh969gWeMM--mYCEXpQkg_AUIEufDj';
  window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
  
  console.log('Mo Chat: Supabase initialized');
</script>

<script>
// Mo's Chat Functionality - Enhanced Version
document.addEventListener('DOMContentLoaded', function() {
  // DOM Elements
  const chatInput = document.getElementById('chat-input');
  const chatSend = document.getElementById('chat-send');
  const chatMessages = document.getElementById('chat-messages');
  const fileUpload = document.getElementById('file-upload');
  const filePreview = document.getElementById('file-preview');
  const fileName = document.getElementById('file-name');
  const fileSize = document.getElementById('file-size');
  const fileIcon = document.getElementById('file-icon');
  const removeFile = document.getElementById('remove-file');
  const typingIndicator = document.getElementById('typing-indicator');
  const connectionStatus = document.getElementById('connection-status');
  const chatStatus = document.getElementById('chat-status');
  
  let selectedFile = null;
  let messageCount = 0;
  let conversationContext = [];
  let lastMessageTime = Date.now();
  let userTyping = false;
  let typingTimeout;
  
  // Initialize chat
  initializeChat();
  
  // File upload handler
  fileUpload.addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
      selectedFile = e.target.files[0];
      
      // Check file size (10MB limit)
      if (selectedFile.size > 10 * 1024 * 1024) {
        showNotification('File too large! Max 10MB allowed.', 'error');
        selectedFile = null;
        fileUpload.value = '';
        return;
      }
      
      // Validate file type
      const allowedTypes = ['image/', 'application/pdf', 'text/', 'application/msword', 
                           'application/vnd.openxmlformats-officedocument'];
      const isAllowed = allowedTypes.some(type => selectedFile.type.includes(type));
      
      if (!isAllowed) {
        showNotification('File type not supported. Please upload images, PDFs, or documents.', 'warning');
        selectedFile = null;
        fileUpload.value = '';
        return;
      }
      
      // Show file preview
      fileName.textContent = truncateFileName(selectedFile.name, 25);
      fileSize.textContent = formatFileSize(selectedFile.size);
      fileIcon.textContent = getFileIcon(selectedFile.type, selectedFile.name);
      filePreview.style.display = 'flex';
      
      // Show preview for images
      if (selectedFile.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.createElement('div');
          preview.innerHTML = `<img src="${e.target.result}" style="max-width: 100px; max-height: 60px; border-radius: 4px; margin-top: 5px;" alt="Preview">`;
          filePreview.appendChild(preview);
        };
        reader.readAsDataURL(selectedFile);
      }
    }
  });
  
  // Remove selected file
  removeFile.addEventListener('click', function() {
    selectedFile = null;
    fileUpload.value = '';
    filePreview.style.display = 'none';
    // Remove any image preview
    const imgPreview = filePreview.querySelector('img');
    if (imgPreview) imgPreview.remove();
  });
  
  // Send message on button click
  chatSend.addEventListener('click', sendMessageToMo);
  
  // Typing detection
  chatInput.addEventListener('input', function() {
    userTyping = true;
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => userTyping = false, 1000);
  });
  
  // Send on Enter key (with Shift+Enter for new line)
  chatInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessageToMo();
    }
  });
  
  // Initialize chat
  async function initializeChat() {
    updateChatStatus('initializing', 'üîÑ Loading conversation...');
    await loadChatHistory();
    updateChatStatus('active', 'üü¢ Connected');
    
    // Add welcome message if no messages
    if (conversationContext.length === 0) {
      setTimeout(() => {
        addMessage('Mo', getMoResponse('greeting'), null, false, true);
      }, 1000);
    }
  }
  
  // Send message to Mo
  async function sendMessageToMo() {
    const textMessage = chatInput.value.trim();
    
    if (!textMessage && !selectedFile) {
      showNotification('Please type a message or select a file.', 'info');
      chatInput.focus();
      return;
    }
    
    // Disable inputs during processing
    typingIndicator.style.display = 'flex';
    chatSend.disabled = true;
    chatInput.disabled = true;
    
    let fileUrl = null, uploadedFileName = null, fileType = null, fileSize = null;
    
    // Upload file if exists
    if (selectedFile) {
      updateChatStatus('uploading', 'üì§ Uploading file...');
      
      try {
        const fileExt = selectedFile.name.split('.').pop();
        const fileNameUnique = `mo_chat_${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
        
        // Upload to Supabase Storage
        const { data: uploadData, error: uploadError } = await window.supabaseClient
          .storage
          .from('chat-files')
          .upload(fileNameUnique, selectedFile, {
            cacheControl: '3600',
            upsert: false
          });
        
        if (uploadError) throw uploadError;
        
        // Get public URL
        const { data: urlData } = window.supabaseClient
          .storage
          .from('chat-files')
          .getPublicUrl(fileNameUnique);
        
        fileUrl = urlData.publicUrl;
        uploadedFileName = selectedFile.name;
        fileType = selectedFile.type;
        fileSize = selectedFile.size;
        
        // Show file in chat
        addFileMessage(selectedFile, true);
        
        updateChatStatus('active', '‚úÖ File uploaded');
        
      } catch (uploadError) {
        console.error('File upload error:', uploadError);
        updateChatStatus('error', '‚ùå Upload failed');
        addSystemMessage('Failed to upload file. Please try again or send without the file.');
        typingIndicator.style.display = 'none';
        chatSend.disabled = false;
        chatInput.disabled = false;
        return;
      }
    }
    
    // Add user text message to UI
    if (textMessage) {
      addMessage('You', textMessage, null, true);
      conversationContext.push({ sender: 'user', content: textMessage });
    }
    
    // Save to database with "mo_chat" room
    try {
      updateChatStatus('saving', 'üíæ Saving message...');
      
      const { data: messageData, error: messageError } = await window.supabaseClient
        .from('chat_messages')
        .insert([{
          sender: 'You',
          message: textMessage,
          file_url: fileUrl,
          file_name: uploadedFileName,
          file_type: fileType,
          file_size: fileSize,
          room: 'mo_chat',
          metadata: {
            context_length: conversationContext.length,
            has_file: !!selectedFile,
            timestamp: new Date().toISOString()
          }
        }])
        .select();
      
      if (messageError) throw messageError;
      
      console.log('Message saved to Mo chat:', messageData);
      
    } catch (dbError) {
      console.error('Database error:', dbError);
      addSystemMessage('Message sent but not saved to history.');
    }
    
    // Clear inputs
    chatInput.value = '';
    if (selectedFile) {
      selectedFile = null;
      fileUpload.value = '';
      filePreview.style.display = 'none';
      const imgPreview = filePreview.querySelector('img');
      if (imgPreview) imgPreview.remove();
    }
    
    messageCount++;
    lastMessageTime = Date.now();
    
    // Generate Mo's response
    setTimeout(async () => {
      await generateMoResponse(textMessage, !!selectedFile);
    }, 800);
  }
  
  // Generate Mo's response
  async function generateMoResponse(userMessage, hasFile = false) {
    updateChatStatus('typing', '‚úçÔ∏è Mo is typing...');
    
    // Simulate typing delay
    const typingDelay = 1000 + Math.random() * 1500;
    
    setTimeout(async () => {
      // Analyze message for context
      const messageType = analyzeMessageType(userMessage);
      const moResponse = getMoResponse(messageType, userMessage, hasFile);
      
      // Add Mo's response to chat
      addMessage('Mo', moResponse, null, false, true);
      
      // Save Mo's response to database
      try {
        const { data: responseData, error: responseError } = await window.supabaseClient
          .from('chat_messages')
          .insert([{
            sender: 'Mo',
            message: moResponse,
            room: 'mo_chat',
            metadata: {
              response_to: userMessage,
              message_type: messageType,
              timestamp: new Date().toISOString()
            }
          }])
          .select();
        
        if (responseError) throw responseError;
        
        conversationContext.push({ sender: 'mo', content: moResponse });
        
        // Keep context manageable
        if (conversationContext.length > 20) {
          conversationContext = conversationContext.slice(-10);
        }
        
      } catch (error) {
        console.error('Failed to save Mo response:', error);
      }
      
      // Update UI
      typingIndicator.style.display = 'none';
      chatSend.disabled = false;
      chatInput.disabled = false;
      chatInput.focus();
      updateChatStatus('active', 'üü¢ Mo replied');
      
    }, typingDelay);
  }
  
  // Load chat history
  async function loadChatHistory() {
    try {
      const { data: messages, error } = await window.supabaseClient
        .from('chat_messages')
        .select('*')
        .eq('room', 'mo_chat')
        .order('timestamp', { ascending: true })
        .limit(50);
      
      if (error) throw error;
      
      // Clear except welcome message
      const children = chatMessages.children;
      while (children.length > 1) {
        chatMessages.removeChild(children[1]);
      }
      
      // Add messages to UI and context
      messages.forEach(msg => {
        const isUser = msg.sender === 'Visitor' || msg.sender === 'You';
        
        if (msg.file_url) {
          const fileInfo = {
            name: msg.file_name || 'File',
            size: msg.file_size || 0,
            type: msg.file_type || 'FILE',
            url: msg.file_url
          };
          addMessage(msg.sender, null, fileInfo, isUser, msg.sender === 'Mo');
        }
        
        if (msg.message) {
          addMessage(msg.sender, msg.message, null, isUser, msg.sender === 'Mo');
          
          // Add to conversation context
          if (msg.sender === 'You' || msg.sender === 'Visitor') {
            conversationContext.push({ sender: 'user', content: msg.message });
          } else if (msg.sender === 'Mo') {
            conversationContext.push({ sender: 'mo', content: msg.message });
          }
        }
      });
      
      console.log('Loaded', messages.length, 'Mo chat messages');
      updateChatStatus('active', `üü¢ ${messages.length} messages loaded`);
      
    } catch (error) {
      console.error('Failed to load chat history:', error);
      updateChatStatus('error', 'üî¥ Connection issue - using offline mode');
      
      // Fallback: Add sample conversation
      if (conversationContext.length === 0) {
        setTimeout(() => {
          addMessage('Mo', getMoResponse('greeting'), null, false, true);
        }, 500);
      }
    }
  }
  
  // Enhanced message type analysis
  function analyzeMessageType(message) {
    if (!message) return 'greeting';
    
    const msg = message.toLowerCase().trim();
    
    // Check for greetings
    if (msg.match(/\b(hi|hello|hey|greetings|what's up|howdy)\b/)) return 'greeting';
    
    // Check for questions
    if (msg.includes('?') || msg.match(/\b(what|when|where|why|how|who|can|could|would|should|do you)\b/)) {
      if (msg.match(/\b(project|work|portfolio|experience|skill)\b/)) return 'question_project';
      if (msg.match(/\b(contact|email|phone|reach|available)\b/)) return 'question_contact';
      if (msg.match(/\b(time|when|schedule|available)\b/)) return 'question_time';
      return 'question_general';
    }
    
    // Check for file-related
    if (msg.match(/\b(file|document|image|picture|photo|attach|upload|send)\b/)) return 'file_related';
    
    // Check for urgency
    if (msg.match(/\b(urgent|asap|quick|fast|immediate|emergency|important)\b/)) return 'urgent';
    
    // Check for thanks
    if (msg.match(/\b(thank|thanks|appreciate|grateful)\b/)) return 'thanks';
    
    // Check for goodbye
    if (msg.match(/\b(bye|goodbye|see you|later|farewell)\b/)) return 'goodbye';
    
    return 'general';
  }
  
  // Enhanced Mo responses
  function getMoResponse(type, userMessage = '', hasFile = false) {
    const responses = {
      greeting: [
        "Hey there! üëã I'm Mo. I'm currently away from my desk, but I'll get back to you as soon as I can. Feel free to share what's on your mind!",
        "Hello! Thanks for reaching out. I'm not available at the moment, but I make it a priority to respond to messages within a few hours. What can I help you with?",
        "Hi! üëã I see your message. I'm currently working on some projects but will definitely reply when I take a break. Go ahead and tell me what brings you here!"
      ],
      question_general: [
        "That's an interesting question! Let me think about it and get back to you with a proper response. In the meantime, feel free to ask anything else or share more details.",
        "I appreciate your question. I want to give it the attention it deserves, so I'll provide a thoughtful response when I'm back at my computer.",
        "Good question! I'll make sure to address this properly in my response. Is there anything specific you'd like me to focus on when I reply?"
      ],
      question_project: [
        "I'd love to tell you about my projects! I'm currently working on some exciting things. Let me gather the latest details and share them with you when I respond.",
        "Great question about my work! I've been diving deep into some interesting challenges lately. I'll send you updates on my current projects when I reply.",
        "Thanks for asking about my projects! Each one has its own story. I'll share details about my approach, challenges, and outcomes in my response."
      ],
      question_contact: [
        "The best way to reach me is via email, but I'll share my preferred contact methods and availability in my response. Looking forward to connecting!",
        "I have several ways to stay in touch. Let me get back to you with my contact preferences and when I'm typically available for calls or meetings.",
        "Great that you want to connect! I'll share my contact details and suggest some times that usually work well for me."
      ],
      question_time: [
        "I typically check messages a few times a day and aim to respond within 4-6 hours. For urgent matters, I'll prioritize getting back to you sooner.",
        "My response time is usually within a few hours during the day. If you need immediate assistance, please let me know and I'll do my best to help quickly.",
        "I'm most responsive during [your timezone] business hours, but I check messages regularly. I'll get back to you as soon as possible!"
      ],
      file_related: [
        hasFile ? "Thanks for sharing that file! I'll take a look at it as soon as I can and include my thoughts in my response." : 
                 "I can definitely review files you send. Feel free to upload documents, images, or other files - I'll provide feedback when I respond.",
        hasFile ? "I've received your file and will examine it carefully. Looking forward to discussing it with you in my reply!" :
                 "I'm happy to look at any files you'd like to share. Just upload them and I'll review them when I respond to your message."
      ],
      urgent: [
        "I understand this is urgent. I'll prioritize your message and get back to you as soon as possible. Please share any additional details that might help me assist you faster.",
        "Noted as urgent! I'll make sure to address this promptly. Is there a specific timeframe you're working with?",
        "Thanks for flagging this as urgent. I'll focus on your message right away and respond shortly."
      ],
      thanks: [
        "You're very welcome! I'm glad I could help. Don't hesitate to reach out if you have any other questions or need further assistance.",
        "My pleasure! I appreciate you taking the time to connect. Looking forward to our continued conversation.",
        "Thank YOU for reaching out! It's always great to connect with interesting people. Have a wonderful day! üòä"
      ],
      goodbye: [
        "Take care! Feel free to message again anytime. Have a great day! üëã",
        "Goodbye for now! Don't hesitate to reach out if you think of anything else. Stay well!",
        "See you later! It was nice chatting with you. Until next time! ‚ú®"
      ],
      general: [
        "Thanks for your message! I've received it and will respond with my thoughts when I'm back at my computer.",
        "Message received! I'll go through this carefully and get back to you with a thoughtful response.",
        "Got it! I'm currently away but will reply as soon as I can. In the meantime, feel free to add anything else you'd like me to know."
      ]
    };
    
    const typeResponses = responses[type] || responses.general;
    return typeResponses[Math.floor(Math.random() * typeResponses.length)];
  }
  
  // Helper functions
  function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' bytes';
    else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    else return (bytes / 1048576).toFixed(1) + ' MB';
  }
  
  function getFileIcon(fileType, fileName) {
    if (fileType.startsWith('image/')) return 'üñºÔ∏è';
    if (fileType.includes('pdf')) return 'üìÑ';
    if (fileType.includes('spreadsheet') || fileName.match(/\.(xls|xlsx|csv)$/i)) return 'üìä';
    if (fileType.includes('document') || fileName.match(/\.(doc|docx|rtf)$/i)) return 'üìù';
    if (fileType.includes('presentation') || fileName.match(/\.(ppt|pptx)$/i)) return 'üìä';
    if (fileType.includes('text') || fileName.match(/\.txt$/i)) return 'üìÑ';
    if (fileType.includes('archive') || fileName.match(/\.(zip|rar|7z|tar)$/i)) return 'üì¶';
    if (fileType.includes('audio')) return 'üéµ';
    if (fileType.includes('video')) return 'üé¨';
    return 'üìé';
  }
  
  function truncateFileName(name, maxLength) {
    if (name.length <= maxLength) return name;
    const extension = name.split('.').pop();
    const nameWithoutExt = name.slice(0, -(extension.length + 1));
    const truncated = nameWithoutExt.slice(0, maxLength - extension.length - 4) + '...';
    return truncated + '.' + extension;
  }
  
  function addMessage(sender, text, fileInfo = null, isUser = true, isMoResponse = false) {
    const messageDiv = document.createElement('div');
    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    
    messageDiv.id = messageId;
    messageDiv.className = 'chat-message' + (isUser ? ' user-message' : ' mo-message');
    
    let content = '';
    let fileSection = '';
    
    // File preview section
    if (fileInfo) {
      const isImage = fileInfo.type && (fileInfo.type.includes('image') || fileInfo.name.match(/\.(jpg|jpeg|png|gif|webp)$/i));
      
      fileSection = `
        <div class="file-preview-message" style="background: ${isUser ? '#e3f2fd' : '#f5f5f5'}; padding: 15px; border-radius: 12px; margin: 8px 0;">
          <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
            ${getFileIcon('', fileInfo.name)} ${fileInfo.name}
          </div>
          <div style="font-size: 13px; color: #666; margin-bottom: 8px;">
            ${formatFileSize(fileInfo.size)} ‚Ä¢ ${fileInfo.type}
          </div>
          ${isImage && fileInfo.url ? `
            <img src="${fileInfo.url}" alt="${fileInfo.name}" 
                 style="max-width: 200px; max-height: 150px; border-radius: 8px; cursor: pointer;" 
                 onclick="window.open('${fileInfo.url}', '_blank')">
          ` : fileInfo.url ? `
            <a href="${fileInfo.url}" target="_blank" style="display: inline-block; padding: 6px 12px; background: #667eea; color: white; border-radius: 6px; text-decoration: none; font-size: 13px;">
              üì• Download File
            </a>
          ` : ''}
        </div>
      `;
      content += fileSection;
    }
    
    // Text content
    if (text) {
      const formattedText = text.replace(/\n/g, '<br>');
      content += `<div class="message-text" style="margin: ${fileInfo ? '12px' : '8px'} 0; line-height: 1.5;">${formattedText}</div>`;
    }
    
    // Avatar based on sender
    const avatar = isUser ? 'üë§' : (isMoResponse ? 'üëë' : 'ü§ñ');
    const senderDisplay = isUser ? 'You' : sender;
    
    messageDiv.innerHTML = `
      <div style="margin-bottom: 20px; display: flex; ${isUser ? 'justify-content: flex-end;' : ''}">
        ${!isUser ? `
          <div style="margin-right: 10px; display: flex; align-items: flex-start;">
            <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                        border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                        font-size: 18px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
              ${avatar}
            </div>
          </div>
        ` : ''}
        
        <div style="max-width: 75%; background: ${isUser ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'white'}; 
                    color: ${isUser ? 'white' : '#333'}; 
                    padding: 18px 22px; border-radius: 20px; 
                    border: ${!isUser ? '1px solid #e0e0e0' : 'none'};
                    box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
          <div style="font-weight: 700; font-size: 14px; margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
            ${isUser ? 'üë§' : avatar} ${senderDisplay}
            ${isMoResponse ? '<span style="font-size: 11px; opacity: 0.8; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 10px;">Auto-reply</span>' : ''}
          </div>
          ${content}
          <div style="font-size: 11px; opacity: 0.7; text-align: right; margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
            <span>${time}</span>
            ${isUser ? '<span style="font-size: 10px;">‚úì Delivered</span>' : ''}
          </div>
        </div>
        
        ${isUser ? `
          <div style="margin-left: 10px; display: flex; align-items: flex-start;">
            <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); 
                        border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                        font-size: 18px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
              üë§
            </div>
          </div>
        ` : ''}
      </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Add subtle animation for new messages
    setTimeout(() => {
      messageDiv.style.opacity = '1';
      messageDiv.style.transform = 'translateY(0)';
    }, 10);
    
    messageDiv.style.opacity = '0';
    messageDiv.style.transform = isUser ? 'translateY(10px) translateX(10px)' : 'translateY(10px) translateX(-10px)';
    messageDiv.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
  }
  
  function addFileMessage(file, isUser = true) {
    const fileInfo = {
      name: file.name,
      size: file.size,
      type: file.type.split('/')[1]?.toUpperCase() || 'FILE'
    };
    addMessage(isUser ? 'You' : 'Mo', null, fileInfo, isUser);
  }
  
  function addSystemMessage(text) {
    const messageDiv = document.createElement('div');
    messageDiv.innerHTML = `
      <div style="text-align: center; margin: 10px 0;">
        <span style="background: #f0f0f0; padding: 4px 12px; border-radius: 12px; font-size: 12px; color: #666;">
          ${text}
        </span>
      </div>
    `;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
  
  function showNotification(message, type = 'info') {
    const colors = {
      info: '#667eea',
      success: '#10b981',
      warning: '#f59e0b',
      error: '#ef4444'
    };
    
    const notification = document.createElement('div');
    notification.innerHTML = `
      <div style="position: fixed; top: 20px; right: 20px; background: ${colors[type]}; 
                  color: white; padding: 12px 20px; border-radius: 8px; 
                  box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000;
                  display: flex; align-items: center; gap: 10px;">
        <span>${type === 'info' ? 'üí°' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ùå'}</span>
        <span>${message}</span>
      </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.opacity = '0';
      notification.style.transform = 'translateY(-20px)';
      notification.style.transition = 'opacity 0.3s, transform 0.3s';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }
  
  function updateChatStatus(status, message) {
    if (chatStatus) {
      chatStatus.textContent = message;
      
      // Update connection status indicator too
      if (connectionStatus) {
        const icon = message.charAt(0);
        connectionStatus.innerHTML = `${icon} ${status}`;
      }
    }
  }
  
  // Auto-refresh every 20 seconds if user is active
  setInterval(() => {
    const timeSinceLastMsg = Date.now() - lastMessageTime;
    const isUserInactive = timeSinceLastMsg > 30000; // 30 seconds
    
    if (!userTyping && isUserInactive && chatMessages.children.length > 1) {
      loadChatHistory();
    }
  }, 20000);
  
  // Add CSS for better transitions
  const style = document.createElement('style');
  style.textContent = `
    .chat-message {
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    #chat-messages {
      scroll-behavior: smooth;
    }
    #typing-indicator {
      transition: opacity 0.3s ease;
    }
    .file-preview-message img:hover {
      transform: scale(1.02);
      transition: transform 0.2s ease;
    }
  `;
  document.head.appendChild(style);
  
  console.log('Mo Chat Enhanced v2.0 initialized');
});
</script>
